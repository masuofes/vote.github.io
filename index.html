<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>文化祭人気投票</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #e8f5e8, #f0e6ff);
        min-height: 100vh;
        touch-action: manipulation;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        position: relative;
      }

      h1 {
        text-align: center;
        color: #4a5568;
        margin-bottom: 30px;
        font-size: 2.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* ページ表示制御 */
      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      /* 投票ページスタイル */
      .voting-page {
        /* 背景画像を設定する場合は以下のコメントアウトを解除し、URLを変更してください */
        /* background-image: url('image/background.jpg'); */
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        border-radius: 20px;
        padding: 30px;
        margin: 20px;
        position: relative;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        background: linear-gradient(135deg, #e8f5e8, #f0e6ff);
      }

      .voting-page::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        z-index: 0;
      }

      .voting-content {
        position: relative;
        z-index: 1;
      }

      .category-slider {
        display: flex;
        overflow: hidden;
        border-radius: 15px;
        margin-bottom: 30px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .category {
        flex: 1;
        padding: 20px;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        color: #4a5568;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        outline: none;
      }

      .category.active {
        background: linear-gradient(45deg, #9f7aea, #68d391);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      /* 浮いているように見える選択肢のみ */
      .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        flex: 1;
        padding: 20px 0;
      }

      .project-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.4s ease;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        border: 3px solid transparent;
        position: relative;
        overflow: hidden;
        transform: translateY(0);
      }

      .project-card:hover {
        animation: float 2s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(-10px) rotateX(0deg);
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }
        50% {
          transform: translateY(-25px) rotateX(2deg);
          box-shadow: 0 35px 70px rgba(0, 0, 0, 0.3);
        }
      }

      .project-card::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent,
          rgba(159, 122, 234, 0.1),
          transparent
        );
        transform: rotate(45deg);
        transition: all 0.6s ease;
        opacity: 0;
      }

      .project-card:hover::before {
        opacity: 1;
        animation: shimmer 2s linear infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) rotate(45deg);
        }
      }

      .project-card:hover {
        transform: translateY(-20px) scale(1.05);
        box-shadow: 0 30px 60px rgba(159, 122, 234, 0.3);
        border-color: #9f7aea;
        animation: float 2s ease-in-out infinite;
      }

      .project-card.voted {
        border-color: #68d391;
        background: linear-gradient(135deg, #68d391, #48bb78);
        color: white;
        transform: scale(0.95);
      }

      .project-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 15px;
        margin-bottom: 15px;
        background: #f7fafc;
      }

      .project-name {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .controls {
        text-align: center;
        margin-top: 30px;
      }

      .btn {
        background: linear-gradient(45deg, #9f7aea, #68d391);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 1.1rem;
        cursor: pointer;
        margin: 0 10px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(159, 122, 234, 0.4);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn.danger {
        background: linear-gradient(45deg, #e53e3e, #c53030);
      }

      .btn.danger:hover {
        box-shadow: 0 10px 25px rgba(229, 62, 62, 0.4);
      }

      /* 作成ページスタイル */
      .creation-page {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin: 20px;
        min-height: 80vh;
      }

      .projects-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 30px;
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .projects-table th,
      .projects-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }

      .projects-table th {
        background: linear-gradient(45deg, #9f7aea, #68d391);
        color: white;
        font-weight: bold;
        font-size: 1rem;
      }

      .projects-table tr:hover {
        background: #f7fafc;
      }

      .projects-table tr:last-child td {
        border-bottom: none;
      }

      .table-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
        font-size: 0.9rem;
      }

      .table-input:focus {
        outline: none;
        border-color: #9f7aea;
        box-shadow: 0 0 0 2px rgba(159, 122, 234, 0.1);
      }

      .table-select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
        font-size: 0.9rem;
        background: white;
      }

      .table-select:focus {
        outline: none;
        border-color: #9f7aea;
      }

      .row-number {
        background: linear-gradient(45deg, #9f7aea, #68d391);
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin: 0 auto;
      }

      .action-btn {
        background: #e53e3e;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
        margin: 0 5px;
      }

      .action-btn:hover {
        background: #c53030;
      }

      .action-btn.add {
        background: #38a169;
      }

      .action-btn.add:hover {
        background: #2f855a;
      }

      /* 結果ページスタイル */
      .results-page {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin: 20px;
        min-height: 80vh;
      }

      .vote-count-display {
        background: linear-gradient(45deg, #9f7aea, #68d391);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        display: inline-block;
        margin-bottom: 10px;
      }

      /* 円グラフページ */
      .chart-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      #chart-canvas {
        max-width: 400px;
        max-height: 400px;
        margin-bottom: 20px;
        cursor: pointer;
      }

      .chart-tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 14px;
        pointer-events: none;
        z-index: 1000;
        display: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .chart-legend {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
      }

      /* 完了メッセージ */
      .completion-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(45deg, #68d391, #48bb78);
        color: white;
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        animation: fadeInScale 0.5s ease;
      }

      @keyframes fadeInScale {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
        100% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      /* 確認ダイアログ */
      .confirm-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        z-index: 1001;
        max-width: 400px;
        width: 90%;
      }

      .confirm-dialog h3 {
        margin-bottom: 20px;
        color: #e53e3e;
      }

      .confirm-dialog p {
        margin-bottom: 25px;
        color: #4a5568;
      }

      .confirm-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      /* レスポンシブデザイン */
      @media (max-width: 768px) {
        .projects-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 15px;
        }

        .project-card {
          padding: 15px;
        }

        .project-image {
          height: 80px;
        }

        h1 {
          font-size: 2rem;
        }

        .container {
          padding: 10px;
        }

        .voting-page {
          padding: 10px;
        }
      }

      .navigation {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        z-index: 100;
      }

      .nav-btn {
        background: rgba(255, 255, 255, 0.95);
        color: #4a5568;
        border: 2px solid #9f7aea;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        font-weight: bold;
      }

      .nav-btn:hover {
        background: #9f7aea;
        color: white;
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 投票ページ -->
      <div id="voting-page" class="page active">
        <div class="voting-page">
          <div class="voting-content">
            <h1>文化祭人気投票</h1>

            <div class="category-slider">
              <button class="category active" data-category="high-school">
                高校企画
              </button>
              <button class="category" data-category="middle-school">
                中学企画
              </button>
              <button class="category" data-category="club">
                部活サークル企画
              </button>
            </div>

            <div class="projects-grid" id="projects-grid">
              <!-- プロジェクトカードがここに動的に生成される -->
            </div>

            <div class="controls">
              <button class="btn" id="back-btn" disabled>戻る</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 作成ページ -->
      <div id="creation-page" class="page">
        <div class="creation-page">
          <h1>企画管理</h1>

          <div class="controls">
            <button class="btn" id="add-row-btn">新しい行を追加</button>
            <button class="btn" id="save-changes-btn">変更を保存</button>
          </div>

          <!-- 企画一覧テーブル -->
          <table class="projects-table" id="projects-table">
            <thead>
              <tr>
                <th style="width: 60px">番号</th>
                <th style="width: 30%">企画名</th>
                <th style="width: 40%">画像URL</th>
                <th style="width: 20%">カテゴリ</th>
                <th style="width: 10%">操作</th>
              </tr>
            </thead>
            <tbody id="projects-table-body">
              <!-- テーブル行がここに動的に生成される -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- 結果ページ -->
      <div id="results-page" class="page">
        <div class="results-page">
          <h1>投票結果</h1>

          <div class="category-slider" id="results-categories">
            <button class="category active" data-category="high-school">
              高校企画
            </button>
            <button class="category" data-category="middle-school">
              中学企画
            </button>
            <button class="category" data-category="club">
              部活サークル企画
            </button>
            <button class="category" data-category="chart">
              円グラフページ
            </button>
          </div>

          <div id="results-content">
            <div class="projects-grid" id="results-grid">
              <!-- 結果がここに表示される -->
            </div>

            <div id="chart-view" style="display: none">
              <div class="chart-container">
                <div style="position: relative">
                  <canvas id="chart-canvas"></canvas>
                  <div class="chart-tooltip" id="chart-tooltip"></div>
                </div>
                <div class="chart-legend" id="chart-legend"></div>
              </div>
            </div>
          </div>

          <div class="controls">
            <button class="btn" id="download-csv">CSV ダウンロード</button>
            <button class="btn danger" id="reset-votes-btn">
              投票数リセット
            </button>
          </div>
        </div>
      </div>

      <!-- ナビゲーション -->
      <div class="navigation">
        <button class="nav-btn" onclick="showPage('voting-page')">
          投票ページ
        </button>
        <button class="nav-btn" onclick="showPage('creation-page')">
          作成ページ
        </button>
        <button class="nav-btn" onclick="showPage('results-page')">
          結果ページ
        </button>
      </div>
    </div>

    <!-- 完了メッセージ -->
    <div id="completion-overlay" class="overlay" style="display: none">
      <div class="completion-message">
        <h2>投票が完了しました！</h2>
        <p>ご協力ありがとうございました</p>
        <p style="margin-top: 20px; font-size: 1rem">
          2秒後に自動的にリセットされます
        </p>
      </div>
    </div>

    <!-- 確認ダイアログ -->
    <div id="confirm-overlay" class="overlay" style="display: none">
      <div class="confirm-dialog">
        <h3>⚠️ 投票数リセット確認</h3>
        <p>
          本当にすべての投票数をリセットしますか？<br />この操作は取り消せません。
        </p>
        <div class="confirm-buttons">
          <button class="btn" onclick="hideConfirmDialog()">キャンセル</button>
          <button class="btn danger" onclick="confirmResetVotes()">
            リセット実行
          </button>
        </div>
      </div>
    </div>

    <script>
      // データストレージ（メモリ内）
      let projects = {
        "high-school": [
          {
            id: 1,
            name: "演劇部公演「青春」",
            image:
              "https://via.placeholder.com/200x120/9f7aea/white?text=演劇部",
            votes: 0,
          },
          {
            id: 2,
            name: "文化部合同展示",
            image:
              "https://via.placeholder.com/200x120/68d391/white?text=文化部",
            votes: 0,
          },
          {
            id: 3,
            name: "軽音楽部ライブ",
            image:
              "https://via.placeholder.com/200x120/9f7aea/white?text=軽音部",
            votes: 0,
          },
        ],
        "middle-school": [
          {
            id: 4,
            name: "科学実験ショー",
            image:
              "https://via.placeholder.com/200x120/68d391/white?text=科学部",
            votes: 0,
          },
          {
            id: 5,
            name: "ダンス発表会",
            image:
              "https://via.placeholder.com/200x120/9f7aea/white?text=ダンス部",
            votes: 0,
          },
        ],
        club: [
          {
            id: 6,
            name: "バスケ部体験",
            image:
              "https://via.placeholder.com/200x120/68d391/white?text=バスケ部",
            votes: 0,
          },
          {
            id: 7,
            name: "美術部作品展示",
            image:
              "https://via.placeholder.com/200x120/9f7aea/white?text=美術部",
            votes: 0,
          },
          {
            id: 8,
            name: "ボランティア活動報告",
            image:
              "https://via.placeholder.com/200x120/68d391/white?text=ボランティア",
            votes: 0,
          },
        ],
      };

      let currentCategory = "high-school";
      let votedProjects = [];
      let remainingVotes = 3;
      let nextProjectId = 9;
      let pendingProjects = [];

      // ページ表示制御
      function showPage(pageId) {
        document.querySelectorAll(".page").forEach((page) => {
          page.classList.remove("active");
        });
        document.getElementById(pageId).classList.add("active");

        if (pageId === "results-page") {
          displayResults();
        } else if (pageId === "creation-page") {
          updatePendingProjectsList();
        }
      }

      // 投票ページの初期化
      function initVotingPage() {
        displayProjects();

        // カテゴリボタンのイベント
        document.querySelectorAll("#voting-page .category").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            document
              .querySelectorAll("#voting-page .category")
              .forEach((b) => b.classList.remove("active"));
            e.target.classList.add("active");
            currentCategory = e.target.dataset.category;
            displayProjects();
          });
        });

        // 戻るボタン
        document
          .getElementById("back-btn")
          .addEventListener("click", undoLastVote);
      }

      // プロジェクト表示（投票数は表示しない）
      function displayProjects() {
        const grid = document.getElementById("projects-grid");
        grid.innerHTML = "";

        projects[currentCategory].forEach((project) => {
          const card = document.createElement("div");
          card.className = `project-card ${
            votedProjects.includes(project.id) ? "voted" : ""
          }`;
          card.innerHTML = `
                    <img src="${project.image}" alt="${project.name}" class="project-image" onerror="this.src='https://via.placeholder.com/200x120/e2e8f0/4a5568?text=画像なし'">
                    <div class="project-name">${project.name}</div>
                `;

          card.addEventListener("click", () => voteForProject(project.id));
          grid.appendChild(card);
        });
      }

      // 投票処理（リセットしない）
      function voteForProject(projectId) {
        if (remainingVotes <= 0 || votedProjects.includes(projectId)) return;

        // 投票記録
        votedProjects.push(projectId);
        remainingVotes--;

        // 票数を増加
        for (let category in projects) {
          const project = projects[category].find((p) => p.id === projectId);
          if (project) {
            project.votes++;
            break;
          }
        }

        displayProjects();

        // 3票投じた場合は完了
        if (remainingVotes === 0) {
          showCompletionMessage();
        } else {
          // 戻るボタンを有効化
          document.getElementById("back-btn").disabled = false;
        }
      }

      // 最後の投票を取り消す
      function undoLastVote() {
        if (votedProjects.length === 0) return;

        const lastProjectId = votedProjects.pop();
        remainingVotes++;

        // 票数を減らす
        for (let category in projects) {
          const project = projects[category].find(
            (p) => p.id === lastProjectId
          );
          if (project) {
            project.votes = Math.max(0, project.votes - 1);
            break;
          }
        }

        displayProjects();

        if (votedProjects.length === 0) {
          document.getElementById("back-btn").disabled = true;
        }
      }

      // 一人の投票完了後のリセット（投票数は保持）
      function resetVotingForNextPerson() {
        votedProjects = [];
        remainingVotes = 3;
        displayProjects();
        document.getElementById("back-btn").disabled = true;
      }

      // 完了メッセージ表示（2秒）
      function showCompletionMessage() {
        document.getElementById("completion-overlay").style.display = "block";

        setTimeout(() => {
          document.getElementById("completion-overlay").style.display = "none";
          resetVotingForNextPerson();
        }, 2000);
      }

      // 作成ページの初期化
      function initCreationPage() {
        document
          .getElementById("add-row-btn")
          .addEventListener("click", addNewRow);
        document
          .getElementById("save-changes-btn")
          .addEventListener("click", saveAllChanges);
        updateProjectsTable();
      }

      // プロジェクトテーブル更新
      function updateProjectsTable() {
        const tbody = document.getElementById("projects-table-body");
        tbody.innerHTML = "";

        let rowNumber = 1;

        // 既存の企画をテーブルに表示
        for (let category in projects) {
          projects[category].forEach((project, index) => {
            addProjectRow(
              rowNumber,
              project.name,
              project.image,
              category,
              project.id
            );
            rowNumber++;
          });
        }
      }

      // プロジェクト行を追加
      function addProjectRow(
        number,
        name = "",
        image = "",
        category = "high-school",
        projectId = null
      ) {
        const tbody = document.getElementById("projects-table-body");
        const row = document.createElement("tr");
        row.dataset.projectId = projectId;
        row.dataset.originalCategory = category;

        const categoryNames = {
          "high-school": "高校企画",
          "middle-school": "中学企画",
          club: "部活サークル企画",
        };

        row.innerHTML = `
                <td>
                    <div class="row-number">${number}</div>
                </td>
                <td>
                    <input type="text" class="table-input project-name-input" value="${name}" placeholder="企画名を入力">
                </td>
                <td>
                    <input type="url" class="table-input project-image-input" value="${image}" placeholder="https://example.com/image.jpg">
                </td>
                <td>
                    <select class="table-select project-category-select">
                        <option value="high-school" ${
                          category === "high-school" ? "selected" : ""
                        }>高校企画</option>
                        <option value="middle-school" ${
                          category === "middle-school" ? "selected" : ""
                        }>中学企画</option>
                        <option value="club" ${
                          category === "club" ? "selected" : ""
                        }>部活サークル企画</option>
                    </select>
                </td>
                <td>
                    <button class="action-btn" onclick="deleteProjectRow(this)">削除</button>
                </td>
            `;

        tbody.appendChild(row);
      }

      // 新しい行を追加
      function addNewRow() {
        const tbody = document.getElementById("projects-table-body");
        const currentRows = tbody.children.length;
        addProjectRow(currentRows + 1);
      }

      // プロジェクト行を削除
      function deleteProjectRow(button) {
        const row = button.closest("tr");
        const projectId = row.dataset.projectId;

        if (projectId) {
          // 既存の企画を削除
          const originalCategory = row.dataset.originalCategory;
          const projectIndex = projects[originalCategory].findIndex(
            (p) => p.id == projectId
          );
          if (projectIndex !== -1) {
            projects[originalCategory].splice(projectIndex, 1);
          }
        }

        row.remove();
        updateRowNumbers();
      }

      // 行番号を更新
      function updateRowNumbers() {
        const rows = document.querySelectorAll("#projects-table-body tr");
        rows.forEach((row, index) => {
          const numberDiv = row.querySelector(".row-number");
          numberDiv.textContent = index + 1;
        });
      }

      // すべての変更を保存
      function saveAllChanges() {
        const rows = document.querySelectorAll("#projects-table-body tr");
        const newProjects = {
          "high-school": [],
          "middle-school": [],
          club: [],
        };

        let hasError = false;

        rows.forEach((row) => {
          const name = row.querySelector(".project-name-input").value.trim();
          const image = row.querySelector(".project-image-input").value.trim();
          const category = row.querySelector(".project-category-select").value;
          const projectId = row.dataset.projectId;

          if (!name) {
            hasError = true;
            return;
          }

          const project = {
            id: projectId ? parseInt(projectId) : nextProjectId++,
            name: name,
            image:
              image ||
              "https://via.placeholder.com/200x120/e2e8f0/4a5568?text=画像なし",
            votes: 0,
          };

          // 既存の企画の場合は投票数を保持
          if (projectId) {
            const originalCategory = row.dataset.originalCategory;
            const originalProject = projects[originalCategory]?.find(
              (p) => p.id == projectId
            );
            if (originalProject) {
              project.votes = originalProject.votes;
            }
          }

          newProjects[category].push(project);
        });

        if (hasError) {
          alert("企画名が空の行があります。すべて入力してください。");
          return;
        }

        // プロジェクトデータを更新
        projects = newProjects;
        updateProjectsTable();
        alert("変更が保存されました！");
      }

      // 結果表示
      function displayResults() {
        // 結果ページのカテゴリボタンイベント
        document
          .querySelectorAll("#results-categories .category")
          .forEach((btn) => {
            btn.addEventListener("click", (e) => {
              document
                .querySelectorAll("#results-categories .category")
                .forEach((b) => b.classList.remove("active"));
              e.target.classList.add("active");
              const category = e.target.dataset.category;

              if (category === "chart") {
                showChartView();
              } else {
                showResultsGrid();
                displayResultsForCategory(category);
              }
            });
          });

        displayResultsForCategory("high-school");
      }

      function showResultsGrid() {
        document.getElementById("results-grid").style.display = "grid";
        document.getElementById("chart-view").style.display = "none";
      }

      function showChartView() {
        document.getElementById("results-grid").style.display = "none";
        document.getElementById("chart-view").style.display = "block";
        createPieChart();
      }

      function displayResultsForCategory(category) {
        const grid = document.getElementById("results-grid");
        grid.innerHTML = "";

        // 票数でソート
        const sortedProjects = [...projects[category]].sort(
          (a, b) => b.votes - a.votes
        );

        sortedProjects.forEach((project, index) => {
          const card = document.createElement("div");
          card.className = "project-card";
          card.innerHTML = `
                    <img src="${project.image}" alt="${
            project.name
          }" class="project-image" onerror="this.src='https://via.placeholder.com/200x120/e2e8f0/4a5568?text=画像なし'">
                    <div class="project-name">${project.name}</div>
                    <div class="vote-count-display">${project.votes}票 ${
            index === 0 && project.votes > 0 ? "🏆" : ""
          }</div>
                `;
          grid.appendChild(card);
        });
      }

      // 円グラフ作成
      function createPieChart() {
        const canvas = document.getElementById("chart-canvas");
        const ctx = canvas.getContext("2d");
        const legend = document.getElementById("chart-legend");
        const tooltip = document.getElementById("chart-tooltip");

        // Canvas サイズ設定
        canvas.width = 400;
        canvas.height = 400;

        // 全体の投票数を計算
        let allProjects = [];
        let totalVotes = 0;
        const colors = [
          "#9f7aea",
          "#68d391",
          "#4299e1",
          "#ed8936",
          "#38b2ac",
          "#e53e3e",
          "#d69e2e",
          "#805ad5",
        ];

        let colorIndex = 0;
        for (let category in projects) {
          projects[category].forEach((project) => {
            if (project.votes > 0) {
              allProjects.push({
                ...project,
                color: colors[colorIndex % colors.length],
                categoryName:
                  category === "high-school"
                    ? "高校企画"
                    : category === "middle-school"
                    ? "中学企画"
                    : "部活サークル企画",
              });
              totalVotes += project.votes;
              colorIndex++;
            }
          });
        }

        // 得票数順にソート
        allProjects.sort((a, b) => b.votes - a.votes);

        if (totalVotes === 0) {
          ctx.fillStyle = "#718096";
          ctx.font = "20px Arial";
          ctx.textAlign = "center";
          ctx.fillText(
            "投票データがありません",
            canvas.width / 2,
            canvas.height / 2
          );
          legend.innerHTML = "";
          return;
        }

        // 円グラフ描画
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(canvas.width, canvas.height) / 2 - 20;

        let currentAngle = -Math.PI / 2; // 12時から開始
        const slices = [];

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        allProjects.forEach((project) => {
          const sliceAngle = (project.votes / totalVotes) * 2 * Math.PI;

          // 扇形描画
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(
            centerX,
            centerY,
            radius,
            currentAngle,
            currentAngle + sliceAngle
          );
          ctx.closePath();
          ctx.fillStyle = project.color;
          ctx.fill();
          ctx.strokeStyle = "white";
          ctx.lineWidth = 3;
          ctx.stroke();

          // スライス情報を保存（ホバー用）
          slices.push({
            project: project,
            startAngle: currentAngle,
            endAngle: currentAngle + sliceAngle,
            centerX: centerX,
            centerY: centerY,
            radius: radius,
          });

          currentAngle += sliceAngle;
        });

        // マウスイベントの設定
        canvas.onmousemove = function (e) {
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          // Canvas座標に変換
          const canvasX = x * (canvas.width / rect.width);
          const canvasY = y * (canvas.height / rect.height);

          // 中心からの距離と角度を計算
          const distance = Math.sqrt(
            (canvasX - centerX) ** 2 + (canvasY - centerY) ** 2
          );
          const angle = Math.atan2(canvasY - centerY, canvasX - centerX);
          const normalizedAngle =
            angle < -Math.PI / 2 ? angle + 2 * Math.PI : angle;

          // 円の内部かチェック
          if (distance <= radius) {
            // どのスライスにいるかチェック
            for (let slice of slices) {
              let startAngle = slice.startAngle;
              let endAngle = slice.endAngle;

              // 角度の正規化
              if (startAngle < -Math.PI / 2) startAngle += 2 * Math.PI;
              if (endAngle < -Math.PI / 2) endAngle += 2 * Math.PI;

              if (
                normalizedAngle >= startAngle &&
                normalizedAngle <= endAngle
              ) {
                // ツールチップ表示
                const percentage = (
                  (slice.project.votes / totalVotes) *
                  100
                ).toFixed(1);
                tooltip.innerHTML = `<strong>${slice.project.name}</strong><br>${slice.project.votes}票 (${percentage}%)`;
                tooltip.style.display = "block";
                tooltip.style.left = e.clientX + 10 + "px";
                tooltip.style.top = e.clientY - 10 + "px";
                return;
              }
            }
          }

          // ツールチップを隠す
          tooltip.style.display = "none";
        };

        canvas.onmouseleave = function () {
          tooltip.style.display = "none";
        };

        // 凡例作成（得票数順）
        legend.innerHTML = "";
        allProjects.forEach((project, index) => {
          const percentage = ((project.votes / totalVotes) * 100).toFixed(1);
          const legendItem = document.createElement("div");
          legendItem.className = "legend-item";
          legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${
                      project.color
                    }"></div>
                    <div>
                        <strong>${index + 1}位: ${project.name}</strong><br>
                        <small>${project.categoryName} - ${
            project.votes
          }票 (${percentage}%)</small>
                    </div>
                `;
          legend.appendChild(legendItem);
        });
      }

      // 投票数リセット確認
      function showResetConfirmDialog() {
        document.getElementById("confirm-overlay").style.display = "block";
      }

      function hideConfirmDialog() {
        document.getElementById("confirm-overlay").style.display = "none";
      }

      function confirmResetVotes() {
        // 全投票数をリセット
        for (let category in projects) {
          projects[category].forEach((project) => {
            project.votes = 0;
          });
        }

        hideConfirmDialog();
        displayResults();
        alert("投票数をリセットしました");
      }

      // CSVダウンロード
      function downloadCSV() {
        let csvContent = "カテゴリ,企画名,票数\n";

        for (let category in projects) {
          const categoryName =
            category === "high-school"
              ? "高校企画"
              : category === "middle-school"
              ? "中学企画"
              : "部活サークル企画";
          projects[category].forEach((project) => {
            csvContent += `${categoryName},"${project.name}",${project.votes}\n`;
          });
        }

        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "投票結果.csv");
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // 初期化
      document.addEventListener("DOMContentLoaded", () => {
        initVotingPage();
        initCreationPage();
        displayProjects();

        // CSVダウンロードボタン
        document
          .getElementById("download-csv")
          .addEventListener("click", downloadCSV);

        // 投票数リセットボタン
        document
          .getElementById("reset-votes-btn")
          .addEventListener("click", showResetConfirmDialog);
      });

      // タッチ操作でのスワイプ機能（投票ページのカテゴリ切り替え）
      let startX = 0;
      let endX = 0;

      document.addEventListener("touchstart", (e) => {
        if (
          document.getElementById("voting-page").classList.contains("active")
        ) {
          startX = e.changedTouches[0].screenX;
        }
      });

      document.addEventListener("touchend", (e) => {
        if (
          document.getElementById("voting-page").classList.contains("active")
        ) {
          endX = e.changedTouches[0].screenX;
          handleSwipe();
        }
      });

      function handleSwipe() {
        const threshold = 50;
        const diff = startX - endX;

        if (Math.abs(diff) > threshold) {
          const categories = ["high-school", "middle-school", "club"];
          const currentIndex = categories.indexOf(currentCategory);

          if (diff > 0 && currentIndex < categories.length - 1) {
            // 左スワイプ（次のカテゴリ）
            switchCategory(categories[currentIndex + 1]);
          } else if (diff < 0 && currentIndex > 0) {
            // 右スワイプ（前のカテゴリ）
            switchCategory(categories[currentIndex - 1]);
          }
        }
      }

      function switchCategory(newCategory) {
        currentCategory = newCategory;
        document.querySelectorAll("#voting-page .category").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.category === newCategory);
        });
        displayProjects();
      }
    </script>
  </body>
</html>
