<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ–‡åŒ–ç¥­äººæ°—æŠ•ç¥¨</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #e8f5e8, #f0e6ff);
        min-height: 100vh;
        touch-action: manipulation;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        position: relative;
      }

      h1 {
        text-align: center;
        color: #4a5568;
        margin-bottom: 30px;
        font-size: 2.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* ãƒšãƒ¼ã‚¸è¡¨ç¤ºåˆ¶å¾¡ */
      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      /* æŠ•ç¥¨ãƒšãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
      .voting-page {
        /* èƒŒæ™¯ç”»åƒã‚’è¨­å®šã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤ã—ã€URLã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ */
        /* background-image: url('image/background.jpg'); */
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        border-radius: 20px;
        padding: 30px;
        margin: 20px;
        position: relative;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        background: linear-gradient(135deg, #e8f5e8, #f0e6ff);
      }

      .voting-page::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        z-index: 0;
      }

      .voting-content {
        position: relative;
        z-index: 1;
      }

      .category-slider {
        display: flex;
        overflow: hidden;
        border-radius: 15px;
        margin-bottom: 30px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .category {
        flex: 1;
        padding: 20px;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        color: #4a5568;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        outline: none;
      }

      .category.active {
        background: linear-gradient(45deg, #9f7aea, #68d391);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      /* æµ®ã„ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹é¸æŠè‚¢ã®ã¿ */
      .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        flex: 1;
        padding: 20px 0;
      }

      .project-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.4s ease;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        border: 3px solid transparent;
        position: relative;
        overflow: hidden;
        transform: translateY(0);
      }

      .project-card:hover {
        animation: float 2s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(-10px) rotateX(0deg);
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }
        50% {
          transform: translateY(-25px) rotateX(2deg);
          box-shadow: 0 35px 70px rgba(0, 0, 0, 0.3);
        }
      }

      .project-card::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent,
          rgba(159, 122, 234, 0.1),
          transparent
        );
        transform: rotate(45deg);
        transition: all 0.6s ease;
        opacity: 0;
      }

      .project-card:hover::before {
        opacity: 1;
        animation: shimmer 2s linear infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) rotate(45deg);
        }
      }

      .project-card:hover {
        transform: translateY(-20px) scale(1.05);
        box-shadow: 0 30px 60px rgba(159, 122, 234, 0.3);
        border-color: #9f7aea;
        animation: float 2s ease-in-out infinite;
      }

      .project-card.voted {
        border-color: #68d391;
        background: linear-gradient(135deg, #68d391, #48bb78);
        color: white;
        transform: scale(0.95);
      }

      .project-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 15px;
        margin-bottom: 15px;
        background: #f7fafc;
      }

      .project-name {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .controls {
        text-align: center;
        margin-top: 30px;
      }

      .btn {
        background: linear-gradient(45deg, #9f7aea, #68d391);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 1.1rem;
        cursor: pointer;
        margin: 0 10px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(159, 122, 234, 0.4);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn.danger {
        background: linear-gradient(45deg, #e53e3e, #c53030);
      }

      .btn.danger:hover {
        box-shadow: 0 10px 25px rgba(229, 62, 62, 0.4);
      }

      /* ä½œæˆãƒšãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
      .creation-page {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin: 20px;
        min-height: 80vh;
      }

      .projects-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 30px;
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .projects-table th,
      .projects-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }

      .projects-table th {
        background: linear-gradient(45deg, #9f7aea, #68d391);
        color: white;
        font-weight: bold;
        font-size: 1rem;
      }

      .projects-table tr:hover {
        background: #f7fafc;
      }

      .projects-table tr:last-child td {
        border-bottom: none;
      }

      .table-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
        font-size: 0.9rem;
      }

      .table-input:focus {
        outline: none;
        border-color: #9f7aea;
        box-shadow: 0 0 0 2px rgba(159, 122, 234, 0.1);
      }

      .table-select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
        font-size: 0.9rem;
        background: white;
      }

      .table-select:focus {
        outline: none;
        border-color: #9f7aea;
      }

      .row-number {
        background: linear-gradient(45deg, #9f7aea, #68d391);
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin: 0 auto;
      }

      .action-btn {
        background: #e53e3e;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
        margin: 0 5px;
      }

      .action-btn:hover {
        background: #c53030;
      }

      .action-btn.add {
        background: #38a169;
      }

      .action-btn.add:hover {
        background: #2f855a;
      }

      /* çµæœãƒšãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
      .results-page {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin: 20px;
        min-height: 80vh;
      }

      .vote-count-display {
        background: linear-gradient(45deg, #9f7aea, #68d391);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        display: inline-block;
        margin-bottom: 10px;
      }

      /* å††ã‚°ãƒ©ãƒ•ãƒšãƒ¼ã‚¸ */
      .chart-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      #chart-canvas {
        max-width: 400px;
        max-height: 400px;
        margin-bottom: 20px;
        cursor: pointer;
      }

      .chart-tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 14px;
        pointer-events: none;
        z-index: 1000;
        display: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .chart-legend {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
      }

      /* å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
      .completion-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(45deg, #68d391, #48bb78);
        color: white;
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        animation: fadeInScale 0.5s ease;
      }

      @keyframes fadeInScale {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
        100% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      /* ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
      .confirm-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        z-index: 1001;
        max-width: 400px;
        width: 90%;
      }

      .confirm-dialog h3 {
        margin-bottom: 20px;
        color: #e53e3e;
      }

      .confirm-dialog p {
        margin-bottom: 25px;
        color: #4a5568;
      }

      .confirm-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
      @media (max-width: 768px) {
        .projects-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 15px;
        }

        .project-card {
          padding: 15px;
        }

        .project-image {
          height: 80px;
        }

        h1 {
          font-size: 2rem;
        }

        .container {
          padding: 10px;
        }

        .voting-page {
          padding: 10px;
        }
      }

      .navigation {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        z-index: 100;
      }

      .nav-btn {
        background: rgba(255, 255, 255, 0.95);
        color: #4a5568;
        border: 2px solid #9f7aea;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        font-weight: bold;
      }

      .nav-btn:hover {
        background: #9f7aea;
        color: white;
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- æŠ•ç¥¨ãƒšãƒ¼ã‚¸ -->
      <div id="voting-page" class="page active">
        <div class="voting-page">
          <div class="voting-content">
            <h1>æ–‡åŒ–ç¥­äººæ°—æŠ•ç¥¨</h1>

            <div class="category-slider">
              <button class="category active" data-category="high-school">
                é«˜æ ¡ä¼ç”»
              </button>
              <button class="category" data-category="middle-school">
                ä¸­å­¦ä¼ç”»
              </button>
              <button class="category" data-category="club">
                éƒ¨æ´»ã‚µãƒ¼ã‚¯ãƒ«ä¼ç”»
              </button>
            </div>

            <div class="projects-grid" id="projects-grid">
              <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
            </div>

            <div class="controls">
              <button class="btn" id="back-btn" disabled>æˆ»ã‚‹</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ä½œæˆãƒšãƒ¼ã‚¸ -->
      <div id="creation-page" class="page">
        <div class="creation-page">
          <h1>ä¼ç”»ç®¡ç†</h1>

          <div class="controls">
            <button class="btn" id="add-row-btn">æ–°ã—ã„è¡Œã‚’è¿½åŠ </button>
            <button class="btn" id="save-changes-btn">å¤‰æ›´ã‚’ä¿å­˜</button>
          </div>

          <!-- ä¼ç”»ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
          <table class="projects-table" id="projects-table">
            <thead>
              <tr>
                <th style="width: 60px">ç•ªå·</th>
                <th style="width: 30%">ä¼ç”»å</th>
                <th style="width: 40%">ç”»åƒURL</th>
                <th style="width: 20%">ã‚«ãƒ†ã‚´ãƒª</th>
                <th style="width: 10%">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="projects-table-body">
              <!-- ãƒ†ãƒ¼ãƒ–ãƒ«è¡ŒãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- çµæœãƒšãƒ¼ã‚¸ -->
      <div id="results-page" class="page">
        <div class="results-page">
          <h1>æŠ•ç¥¨çµæœ</h1>

          <div class="category-slider" id="results-categories">
            <button class="category active" data-category="high-school">
              é«˜æ ¡ä¼ç”»
            </button>
            <button class="category" data-category="middle-school">
              ä¸­å­¦ä¼ç”»
            </button>
            <button class="category" data-category="club">
              éƒ¨æ´»ã‚µãƒ¼ã‚¯ãƒ«ä¼ç”»
            </button>
            <button class="category" data-category="chart">
              å††ã‚°ãƒ©ãƒ•ãƒšãƒ¼ã‚¸
            </button>
          </div>

          <div id="results-content">
            <div class="projects-grid" id="results-grid">
              <!-- çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>

            <div id="chart-view" style="display: none">
              <div class="chart-container">
                <div style="position: relative">
                  <canvas id="chart-canvas"></canvas>
                  <div class="chart-tooltip" id="chart-tooltip"></div>
                </div>
                <div class="chart-legend" id="chart-legend"></div>
              </div>
            </div>
          </div>

          <div class="controls">
            <button class="btn" id="download-csv">CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button class="btn danger" id="reset-votes-btn">
              æŠ•ç¥¨æ•°ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
        </div>
      </div>

      <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div class="navigation">
        <button class="nav-btn" onclick="showPage('voting-page')">
          æŠ•ç¥¨ãƒšãƒ¼ã‚¸
        </button>
        <button class="nav-btn" onclick="showPage('creation-page')">
          ä½œæˆãƒšãƒ¼ã‚¸
        </button>
        <button class="nav-btn" onclick="showPage('results-page')">
          çµæœãƒšãƒ¼ã‚¸
        </button>
      </div>
    </div>

    <!-- å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="completion-overlay" class="overlay" style="display: none">
      <div class="completion-message">
        <h2>æŠ•ç¥¨ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h2>
        <p>ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</p>
        <p style="margin-top: 20px; font-size: 1rem">
          2ç§’å¾Œã«è‡ªå‹•çš„ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™
        </p>
      </div>
    </div>

    <!-- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div id="confirm-overlay" class="overlay" style="display: none">
      <div class="confirm-dialog">
        <h3>âš ï¸ æŠ•ç¥¨æ•°ãƒªã‚»ãƒƒãƒˆç¢ºèª</h3>
        <p>
          æœ¬å½“ã«ã™ã¹ã¦ã®æŠ•ç¥¨æ•°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ<br />ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
        </p>
        <div class="confirm-buttons">
          <button class="btn" onclick="hideConfirmDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn danger" onclick="confirmResetVotes()">
            ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
          </button>
        </div>
      </div>
    </div>

    <script>
      // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆãƒ¡ãƒ¢ãƒªå†…ï¼‰
      let projects = {
        "high-school": [
          {
            id: 1,
            name: "æ¼”åŠ‡éƒ¨å…¬æ¼”ã€Œé’æ˜¥ã€",
            image:
              "https://via.placeholder.com/200x120/9f7aea/white?text=æ¼”åŠ‡éƒ¨",
            votes: 0,
          },
          {
            id: 2,
            name: "æ–‡åŒ–éƒ¨åˆåŒå±•ç¤º",
            image:
              "https://via.placeholder.com/200x120/68d391/white?text=æ–‡åŒ–éƒ¨",
            votes: 0,
          },
          {
            id: 3,
            name: "è»½éŸ³æ¥½éƒ¨ãƒ©ã‚¤ãƒ–",
            image:
              "https://via.placeholder.com/200x120/9f7aea/white?text=è»½éŸ³éƒ¨",
            votes: 0,
          },
        ],
        "middle-school": [
          {
            id: 4,
            name: "ç§‘å­¦å®Ÿé¨“ã‚·ãƒ§ãƒ¼",
            image:
              "https://via.placeholder.com/200x120/68d391/white?text=ç§‘å­¦éƒ¨",
            votes: 0,
          },
          {
            id: 5,
            name: "ãƒ€ãƒ³ã‚¹ç™ºè¡¨ä¼š",
            image:
              "https://via.placeholder.com/200x120/9f7aea/white?text=ãƒ€ãƒ³ã‚¹éƒ¨",
            votes: 0,
          },
        ],
        club: [
          {
            id: 6,
            name: "ãƒã‚¹ã‚±éƒ¨ä½“é¨“",
            image:
              "https://via.placeholder.com/200x120/68d391/white?text=ãƒã‚¹ã‚±éƒ¨",
            votes: 0,
          },
          {
            id: 7,
            name: "ç¾è¡“éƒ¨ä½œå“å±•ç¤º",
            image:
              "https://via.placeholder.com/200x120/9f7aea/white?text=ç¾è¡“éƒ¨",
            votes: 0,
          },
          {
            id: 8,
            name: "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢æ´»å‹•å ±å‘Š",
            image:
              "https://via.placeholder.com/200x120/68d391/white?text=ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢",
            votes: 0,
          },
        ],
      };

      let currentCategory = "high-school";
      let votedProjects = [];
      let remainingVotes = 3;
      let nextProjectId = 9;
      let pendingProjects = [];

      // ãƒšãƒ¼ã‚¸è¡¨ç¤ºåˆ¶å¾¡
      function showPage(pageId) {
        document.querySelectorAll(".page").forEach((page) => {
          page.classList.remove("active");
        });
        document.getElementById(pageId).classList.add("active");

        if (pageId === "results-page") {
          displayResults();
        } else if (pageId === "creation-page") {
          updatePendingProjectsList();
        }
      }

      // æŠ•ç¥¨ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–
      function initVotingPage() {
        displayProjects();

        // ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        document.querySelectorAll("#voting-page .category").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            document
              .querySelectorAll("#voting-page .category")
              .forEach((b) => b.classList.remove("active"));
            e.target.classList.add("active");
            currentCategory = e.target.dataset.category;
            displayProjects();
          });
        });

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        document
          .getElementById("back-btn")
          .addEventListener("click", undoLastVote);
      }

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤ºï¼ˆæŠ•ç¥¨æ•°ã¯è¡¨ç¤ºã—ãªã„ï¼‰
      function displayProjects() {
        const grid = document.getElementById("projects-grid");
        grid.innerHTML = "";

        projects[currentCategory].forEach((project) => {
          const card = document.createElement("div");
          card.className = `project-card ${
            votedProjects.includes(project.id) ? "voted" : ""
          }`;
          card.innerHTML = `
                    <img src="${project.image}" alt="${project.name}" class="project-image" onerror="this.src='https://via.placeholder.com/200x120/e2e8f0/4a5568?text=ç”»åƒãªã—'">
                    <div class="project-name">${project.name}</div>
                `;

          card.addEventListener("click", () => voteForProject(project.id));
          grid.appendChild(card);
        });
      }

      // æŠ•ç¥¨å‡¦ç†ï¼ˆãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼‰
      function voteForProject(projectId) {
        if (remainingVotes <= 0 || votedProjects.includes(projectId)) return;

        // æŠ•ç¥¨è¨˜éŒ²
        votedProjects.push(projectId);
        remainingVotes--;

        // ç¥¨æ•°ã‚’å¢—åŠ 
        for (let category in projects) {
          const project = projects[category].find((p) => p.id === projectId);
          if (project) {
            project.votes++;
            break;
          }
        }

        displayProjects();

        // 3ç¥¨æŠ•ã˜ãŸå ´åˆã¯å®Œäº†
        if (remainingVotes === 0) {
          showCompletionMessage();
        } else {
          // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
          document.getElementById("back-btn").disabled = false;
        }
      }

      // æœ€å¾Œã®æŠ•ç¥¨ã‚’å–ã‚Šæ¶ˆã™
      function undoLastVote() {
        if (votedProjects.length === 0) return;

        const lastProjectId = votedProjects.pop();
        remainingVotes++;

        // ç¥¨æ•°ã‚’æ¸›ã‚‰ã™
        for (let category in projects) {
          const project = projects[category].find(
            (p) => p.id === lastProjectId
          );
          if (project) {
            project.votes = Math.max(0, project.votes - 1);
            break;
          }
        }

        displayProjects();

        if (votedProjects.length === 0) {
          document.getElementById("back-btn").disabled = true;
        }
      }

      // ä¸€äººã®æŠ•ç¥¨å®Œäº†å¾Œã®ãƒªã‚»ãƒƒãƒˆï¼ˆæŠ•ç¥¨æ•°ã¯ä¿æŒï¼‰
      function resetVotingForNextPerson() {
        votedProjects = [];
        remainingVotes = 3;
        displayProjects();
        document.getElementById("back-btn").disabled = true;
      }

      // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆ2ç§’ï¼‰
      function showCompletionMessage() {
        document.getElementById("completion-overlay").style.display = "block";

        setTimeout(() => {
          document.getElementById("completion-overlay").style.display = "none";
          resetVotingForNextPerson();
        }, 2000);
      }

      // ä½œæˆãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–
      function initCreationPage() {
        document
          .getElementById("add-row-btn")
          .addEventListener("click", addNewRow);
        document
          .getElementById("save-changes-btn")
          .addEventListener("click", saveAllChanges);
        updateProjectsTable();
      }

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
      function updateProjectsTable() {
        const tbody = document.getElementById("projects-table-body");
        tbody.innerHTML = "";

        let rowNumber = 1;

        // æ—¢å­˜ã®ä¼ç”»ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¡¨ç¤º
        for (let category in projects) {
          projects[category].forEach((project, index) => {
            addProjectRow(
              rowNumber,
              project.name,
              project.image,
              category,
              project.id
            );
            rowNumber++;
          });
        }
      }

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡Œã‚’è¿½åŠ 
      function addProjectRow(
        number,
        name = "",
        image = "",
        category = "high-school",
        projectId = null
      ) {
        const tbody = document.getElementById("projects-table-body");
        const row = document.createElement("tr");
        row.dataset.projectId = projectId;
        row.dataset.originalCategory = category;

        const categoryNames = {
          "high-school": "é«˜æ ¡ä¼ç”»",
          "middle-school": "ä¸­å­¦ä¼ç”»",
          club: "éƒ¨æ´»ã‚µãƒ¼ã‚¯ãƒ«ä¼ç”»",
        };

        row.innerHTML = `
                <td>
                    <div class="row-number">${number}</div>
                </td>
                <td>
                    <input type="text" class="table-input project-name-input" value="${name}" placeholder="ä¼ç”»åã‚’å…¥åŠ›">
                </td>
                <td>
                    <input type="url" class="table-input project-image-input" value="${image}" placeholder="https://example.com/image.jpg">
                </td>
                <td>
                    <select class="table-select project-category-select">
                        <option value="high-school" ${
                          category === "high-school" ? "selected" : ""
                        }>é«˜æ ¡ä¼ç”»</option>
                        <option value="middle-school" ${
                          category === "middle-school" ? "selected" : ""
                        }>ä¸­å­¦ä¼ç”»</option>
                        <option value="club" ${
                          category === "club" ? "selected" : ""
                        }>éƒ¨æ´»ã‚µãƒ¼ã‚¯ãƒ«ä¼ç”»</option>
                    </select>
                </td>
                <td>
                    <button class="action-btn" onclick="deleteProjectRow(this)">å‰Šé™¤</button>
                </td>
            `;

        tbody.appendChild(row);
      }

      // æ–°ã—ã„è¡Œã‚’è¿½åŠ 
      function addNewRow() {
        const tbody = document.getElementById("projects-table-body");
        const currentRows = tbody.children.length;
        addProjectRow(currentRows + 1);
      }

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¡Œã‚’å‰Šé™¤
      function deleteProjectRow(button) {
        const row = button.closest("tr");
        const projectId = row.dataset.projectId;

        if (projectId) {
          // æ—¢å­˜ã®ä¼ç”»ã‚’å‰Šé™¤
          const originalCategory = row.dataset.originalCategory;
          const projectIndex = projects[originalCategory].findIndex(
            (p) => p.id == projectId
          );
          if (projectIndex !== -1) {
            projects[originalCategory].splice(projectIndex, 1);
          }
        }

        row.remove();
        updateRowNumbers();
      }

      // è¡Œç•ªå·ã‚’æ›´æ–°
      function updateRowNumbers() {
        const rows = document.querySelectorAll("#projects-table-body tr");
        rows.forEach((row, index) => {
          const numberDiv = row.querySelector(".row-number");
          numberDiv.textContent = index + 1;
        });
      }

      // ã™ã¹ã¦ã®å¤‰æ›´ã‚’ä¿å­˜
      function saveAllChanges() {
        const rows = document.querySelectorAll("#projects-table-body tr");
        const newProjects = {
          "high-school": [],
          "middle-school": [],
          club: [],
        };

        let hasError = false;

        rows.forEach((row) => {
          const name = row.querySelector(".project-name-input").value.trim();
          const image = row.querySelector(".project-image-input").value.trim();
          const category = row.querySelector(".project-category-select").value;
          const projectId = row.dataset.projectId;

          if (!name) {
            hasError = true;
            return;
          }

          const project = {
            id: projectId ? parseInt(projectId) : nextProjectId++,
            name: name,
            image:
              image ||
              "https://via.placeholder.com/200x120/e2e8f0/4a5568?text=ç”»åƒãªã—",
            votes: 0,
          };

          // æ—¢å­˜ã®ä¼ç”»ã®å ´åˆã¯æŠ•ç¥¨æ•°ã‚’ä¿æŒ
          if (projectId) {
            const originalCategory = row.dataset.originalCategory;
            const originalProject = projects[originalCategory]?.find(
              (p) => p.id == projectId
            );
            if (originalProject) {
              project.votes = originalProject.votes;
            }
          }

          newProjects[category].push(project);
        });

        if (hasError) {
          alert("ä¼ç”»åãŒç©ºã®è¡ŒãŒã‚ã‚Šã¾ã™ã€‚ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        projects = newProjects;
        updateProjectsTable();
        alert("å¤‰æ›´ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
      }

      // çµæœè¡¨ç¤º
      function displayResults() {
        // çµæœãƒšãƒ¼ã‚¸ã®ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
        document
          .querySelectorAll("#results-categories .category")
          .forEach((btn) => {
            btn.addEventListener("click", (e) => {
              document
                .querySelectorAll("#results-categories .category")
                .forEach((b) => b.classList.remove("active"));
              e.target.classList.add("active");
              const category = e.target.dataset.category;

              if (category === "chart") {
                showChartView();
              } else {
                showResultsGrid();
                displayResultsForCategory(category);
              }
            });
          });

        displayResultsForCategory("high-school");
      }

      function showResultsGrid() {
        document.getElementById("results-grid").style.display = "grid";
        document.getElementById("chart-view").style.display = "none";
      }

      function showChartView() {
        document.getElementById("results-grid").style.display = "none";
        document.getElementById("chart-view").style.display = "block";
        createPieChart();
      }

      function displayResultsForCategory(category) {
        const grid = document.getElementById("results-grid");
        grid.innerHTML = "";

        // ç¥¨æ•°ã§ã‚½ãƒ¼ãƒˆ
        const sortedProjects = [...projects[category]].sort(
          (a, b) => b.votes - a.votes
        );

        sortedProjects.forEach((project, index) => {
          const card = document.createElement("div");
          card.className = "project-card";
          card.innerHTML = `
                    <img src="${project.image}" alt="${
            project.name
          }" class="project-image" onerror="this.src='https://via.placeholder.com/200x120/e2e8f0/4a5568?text=ç”»åƒãªã—'">
                    <div class="project-name">${project.name}</div>
                    <div class="vote-count-display">${project.votes}ç¥¨ ${
            index === 0 && project.votes > 0 ? "ğŸ†" : ""
          }</div>
                `;
          grid.appendChild(card);
        });
      }

      // å††ã‚°ãƒ©ãƒ•ä½œæˆ
      function createPieChart() {
        const canvas = document.getElementById("chart-canvas");
        const ctx = canvas.getContext("2d");
        const legend = document.getElementById("chart-legend");
        const tooltip = document.getElementById("chart-tooltip");

        // Canvas ã‚µã‚¤ã‚ºè¨­å®š
        canvas.width = 400;
        canvas.height = 400;

        // å…¨ä½“ã®æŠ•ç¥¨æ•°ã‚’è¨ˆç®—
        let allProjects = [];
        let totalVotes = 0;
        const colors = [
          "#9f7aea",
          "#68d391",
          "#4299e1",
          "#ed8936",
          "#38b2ac",
          "#e53e3e",
          "#d69e2e",
          "#805ad5",
        ];

        let colorIndex = 0;
        for (let category in projects) {
          projects[category].forEach((project) => {
            if (project.votes > 0) {
              allProjects.push({
                ...project,
                color: colors[colorIndex % colors.length],
                categoryName:
                  category === "high-school"
                    ? "é«˜æ ¡ä¼ç”»"
                    : category === "middle-school"
                    ? "ä¸­å­¦ä¼ç”»"
                    : "éƒ¨æ´»ã‚µãƒ¼ã‚¯ãƒ«ä¼ç”»",
              });
              totalVotes += project.votes;
              colorIndex++;
            }
          });
        }

        // å¾—ç¥¨æ•°é †ã«ã‚½ãƒ¼ãƒˆ
        allProjects.sort((a, b) => b.votes - a.votes);

        if (totalVotes === 0) {
          ctx.fillStyle = "#718096";
          ctx.font = "20px Arial";
          ctx.textAlign = "center";
          ctx.fillText(
            "æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“",
            canvas.width / 2,
            canvas.height / 2
          );
          legend.innerHTML = "";
          return;
        }

        // å††ã‚°ãƒ©ãƒ•æç”»
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(canvas.width, canvas.height) / 2 - 20;

        let currentAngle = -Math.PI / 2; // 12æ™‚ã‹ã‚‰é–‹å§‹
        const slices = [];

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        allProjects.forEach((project) => {
          const sliceAngle = (project.votes / totalVotes) * 2 * Math.PI;

          // æ‰‡å½¢æç”»
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(
            centerX,
            centerY,
            radius,
            currentAngle,
            currentAngle + sliceAngle
          );
          ctx.closePath();
          ctx.fillStyle = project.color;
          ctx.fill();
          ctx.strokeStyle = "white";
          ctx.lineWidth = 3;
          ctx.stroke();

          // ã‚¹ãƒ©ã‚¤ã‚¹æƒ…å ±ã‚’ä¿å­˜ï¼ˆãƒ›ãƒãƒ¼ç”¨ï¼‰
          slices.push({
            project: project,
            startAngle: currentAngle,
            endAngle: currentAngle + sliceAngle,
            centerX: centerX,
            centerY: centerY,
            radius: radius,
          });

          currentAngle += sliceAngle;
        });

        // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
        canvas.onmousemove = function (e) {
          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          // Canvasåº§æ¨™ã«å¤‰æ›
          const canvasX = x * (canvas.width / rect.width);
          const canvasY = y * (canvas.height / rect.height);

          // ä¸­å¿ƒã‹ã‚‰ã®è·é›¢ã¨è§’åº¦ã‚’è¨ˆç®—
          const distance = Math.sqrt(
            (canvasX - centerX) ** 2 + (canvasY - centerY) ** 2
          );
          const angle = Math.atan2(canvasY - centerY, canvasX - centerX);
          const normalizedAngle =
            angle < -Math.PI / 2 ? angle + 2 * Math.PI : angle;

          // å††ã®å†…éƒ¨ã‹ãƒã‚§ãƒƒã‚¯
          if (distance <= radius) {
            // ã©ã®ã‚¹ãƒ©ã‚¤ã‚¹ã«ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            for (let slice of slices) {
              let startAngle = slice.startAngle;
              let endAngle = slice.endAngle;

              // è§’åº¦ã®æ­£è¦åŒ–
              if (startAngle < -Math.PI / 2) startAngle += 2 * Math.PI;
              if (endAngle < -Math.PI / 2) endAngle += 2 * Math.PI;

              if (
                normalizedAngle >= startAngle &&
                normalizedAngle <= endAngle
              ) {
                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º
                const percentage = (
                  (slice.project.votes / totalVotes) *
                  100
                ).toFixed(1);
                tooltip.innerHTML = `<strong>${slice.project.name}</strong><br>${slice.project.votes}ç¥¨ (${percentage}%)`;
                tooltip.style.display = "block";
                tooltip.style.left = e.clientX + 10 + "px";
                tooltip.style.top = e.clientY - 10 + "px";
                return;
              }
            }
          }

          // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’éš ã™
          tooltip.style.display = "none";
        };

        canvas.onmouseleave = function () {
          tooltip.style.display = "none";
        };

        // å‡¡ä¾‹ä½œæˆï¼ˆå¾—ç¥¨æ•°é †ï¼‰
        legend.innerHTML = "";
        allProjects.forEach((project, index) => {
          const percentage = ((project.votes / totalVotes) * 100).toFixed(1);
          const legendItem = document.createElement("div");
          legendItem.className = "legend-item";
          legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${
                      project.color
                    }"></div>
                    <div>
                        <strong>${index + 1}ä½: ${project.name}</strong><br>
                        <small>${project.categoryName} - ${
            project.votes
          }ç¥¨ (${percentage}%)</small>
                    </div>
                `;
          legend.appendChild(legendItem);
        });
      }

      // æŠ•ç¥¨æ•°ãƒªã‚»ãƒƒãƒˆç¢ºèª
      function showResetConfirmDialog() {
        document.getElementById("confirm-overlay").style.display = "block";
      }

      function hideConfirmDialog() {
        document.getElementById("confirm-overlay").style.display = "none";
      }

      function confirmResetVotes() {
        // å…¨æŠ•ç¥¨æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
        for (let category in projects) {
          projects[category].forEach((project) => {
            project.votes = 0;
          });
        }

        hideConfirmDialog();
        displayResults();
        alert("æŠ•ç¥¨æ•°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
      }

      // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      function downloadCSV() {
        let csvContent = "ã‚«ãƒ†ã‚´ãƒª,ä¼ç”»å,ç¥¨æ•°\n";

        for (let category in projects) {
          const categoryName =
            category === "high-school"
              ? "é«˜æ ¡ä¼ç”»"
              : category === "middle-school"
              ? "ä¸­å­¦ä¼ç”»"
              : "éƒ¨æ´»ã‚µãƒ¼ã‚¯ãƒ«ä¼ç”»";
          projects[category].forEach((project) => {
            csvContent += `${categoryName},"${project.name}",${project.votes}\n`;
          });
        }

        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "æŠ•ç¥¨çµæœ.csv");
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // åˆæœŸåŒ–
      document.addEventListener("DOMContentLoaded", () => {
        initVotingPage();
        initCreationPage();
        displayProjects();

        // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
        document
          .getElementById("download-csv")
          .addEventListener("click", downloadCSV);

        // æŠ•ç¥¨æ•°ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
        document
          .getElementById("reset-votes-btn")
          .addEventListener("click", showResetConfirmDialog);
      });

      // ã‚¿ãƒƒãƒæ“ä½œã§ã®ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ï¼ˆæŠ•ç¥¨ãƒšãƒ¼ã‚¸ã®ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆï¼‰
      let startX = 0;
      let endX = 0;

      document.addEventListener("touchstart", (e) => {
        if (
          document.getElementById("voting-page").classList.contains("active")
        ) {
          startX = e.changedTouches[0].screenX;
        }
      });

      document.addEventListener("touchend", (e) => {
        if (
          document.getElementById("voting-page").classList.contains("active")
        ) {
          endX = e.changedTouches[0].screenX;
          handleSwipe();
        }
      });

      function handleSwipe() {
        const threshold = 50;
        const diff = startX - endX;

        if (Math.abs(diff) > threshold) {
          const categories = ["high-school", "middle-school", "club"];
          const currentIndex = categories.indexOf(currentCategory);

          if (diff > 0 && currentIndex < categories.length - 1) {
            // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæ¬¡ã®ã‚«ãƒ†ã‚´ãƒªï¼‰
            switchCategory(categories[currentIndex + 1]);
          } else if (diff < 0 && currentIndex > 0) {
            // å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå‰ã®ã‚«ãƒ†ã‚´ãƒªï¼‰
            switchCategory(categories[currentIndex - 1]);
          }
        }
      }

      function switchCategory(newCategory) {
        currentCategory = newCategory;
        document.querySelectorAll("#voting-page .category").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.category === newCategory);
        });
        displayProjects();
      }
    </script>
  </body>
</html>
